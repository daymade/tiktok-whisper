# 🛠️ 故障排除指南

> 遇到问题不要慌！这里有所有常见问题的解决方案。

## 🚨 紧急救援（万能解决方案）

**如果什么都不工作，试试这个**：
```bash
# 1. 重新初始化
uv sync

# 2. 重新检查配置  
uv run python export_to_md.py config --show

# 3. 如果还是不行，查看下面的具体问题
```

## 📋 安装阶段问题

### ❌ 问题：找不到 uv 命令
```
bash: uv: command not found
```

**💡 解决方案**：
```bash
# 安装 uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# 重新加载环境变量
source ~/.bashrc
# 或者重新打开终端
```

### ❌ 问题：uv sync 失败
```
error: No such file or directory
```

**💡 解决方案**：
```bash
# 确保在正确的目录
cd /你的路径/tiktok-whisper/tools/export-to-md

# 检查是否有 pyproject.toml
ls -la pyproject.toml

# 如果没有，说明目录不对
```

### ❌ 问题：权限被拒绝
```
Permission denied
```

**💡 解决方案**：
```bash
# 给脚本执行权限
# 确保有执行权限（如果有其他脚本的话）
chmod +x *.sh

# 如果是 macOS，可能需要允许执行
sudo xattr -r -d com.apple.quarantine .
```

## 📊 配置阶段问题

### ❌ 问题：数据库文件不存在
```
❌ 数据库文件不存在: ../../data/transcription.db
```

**💡 解决方案**：
```bash
# 1. 找到正确的数据库路径
find /你的路径 -name "transcription.db" 2>/dev/null

# 2. 更新配置
uv run python export_to_md.py config --set database_path="/正确的/路径/transcription.db"

# 3. 验证配置
uv run python export_to_md.py config --show
```

### ❌ 问题：html2md 工具不存在
```
❌ html2md 工具不存在: /path/to/html2md/main.py
```

**💡 解决方案**：
```bash
# 1. 找到 html2md 工具
find /Volumes -name "html2md" -type d 2>/dev/null
find ~ -name "html2md" -type d 2>/dev/null

# 2. 更新配置（替换为正确路径）
uv run python export_to_md.py config --set html2md_path="/正确的/路径/html2md/main.py"

# 3. 验证路径
ls -la /正确的/路径/html2md/main.py
```

## 🔍 使用阶段问题

### ❌ 问题：用户不存在
```
❌ 用户不存在: 用户名
```

**💡 解决方案**：
```bash
# 1. 查看所有用户（注意大小写和空格）
uv run python export_to_md.py list-users

# 2. 复制准确的用户名，包括引号
uv run python export_to_md.py export --user "经纬第二期"
#                                              ^确保有引号^
```

### ❌ 问题：没有数据
```
用户 xxx 没有有效的转录数据
```

**💡 解决方案**：
```bash
# 检查数据库中的数据
uv run python -c "
import sqlite3
conn = sqlite3.connect('../../data/transcription.db')
cursor = conn.execute('SELECT user, has_error, COUNT(*) FROM transcriptions GROUP BY user, has_error')
for row in cursor:
    print(row)
"
```

### ❌ 问题：转换失败
```
html2md 工具执行失败
```

**💡 解决方案**：
```bash
# 1. 检查 html2md 工具是否能独立运行
python /路径/to/html2md/main.py --help

# 2. 检查 JSON 文件格式
uv run python export_to_md.py config --set keep_json=true
# 然后重新导出，检查生成的 JSON 文件

# 3. 手动测试 html2md
cd output
python /路径/to/html2md/main.py temp_export_用户名.json
```

## 💾 文件和路径问题

### ❌ 问题：找不到输出文件
```
未找到生成的 ZIP 文件
```

**💡 解决方案**：
```bash
# 1. 检查当前目录的所有文件
ls -la output/

# 2. 启用调试模式
uv run python export_to_md.py config --set keep_json=true
uv run python export_to_md.py config --set keep_md_files=true

# 3. 重新导出并检查中间文件
uv run python export_to_md.py export --user "用户名"
ls -la output/
```

### ❌ 问题：中文文件名乱码
```
文件名显示为 ??? 或乱码
```

**💡 解决方案**：
```bash
# 设置正确的编码环境
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8

# 重新运行导出
uv run python export_to_md.py export --user "用户名"
```

## 🖥️ 系统特定问题

### 🍎 macOS 问题

**问题：开发者无法验证**
```bash
# 解决方案
sudo xattr -r -d com.apple.quarantine /路径/to/tiktok-whisper/tools/export-to-md
```

**问题：Python 证书错误**
```bash
# 解决方案
/Applications/Python\ 3.x/Install\ Certificates.command
```

### 🪟 Windows 问题

**问题：脚本执行策略**
```powershell
# 解决方案（PowerShell 管理员模式）
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

**问题：路径分隔符**
```bash
# 使用正斜杠，不是反斜杠
uv run python export_to_md.py config --set database_path="C:/path/to/transcription.db"
```

## 🔬 高级调试

### 启用详细日志
```bash
# 查看完整错误信息
uv run python export_to_md.py export --user "用户名" 2>&1 | tee debug.log
```

### 手动测试各组件
```bash
# 1. 测试数据库连接
uv run python -c "
import sqlite3
conn = sqlite3.connect('../../data/transcription.db')
print('数据库连接成功')
print('表结构:', conn.execute('PRAGMA table_info(transcriptions)').fetchall())
"

# 2. 测试 JSON 生成
uv run python -c "
import json
data = [{'mp3_file_name': 'test.mp3', 'transcription': '测试内容'}]
print(json.dumps(data, ensure_ascii=False, indent=2))
"

# 3. 测试 html2md 工具
echo '[{"mp3_file_name": "test.mp3", "transcription": "测试内容"}]' > test.json
python /路径/to/html2md/main.py test.json
```

## 📞 寻求帮助

### 报告问题时提供这些信息：
```bash
# 1. 系统信息
uname -a
python --version
uv --version

# 2. 配置信息
uv run python export_to_md.py config --show

# 3. 错误信息（完整的）
uv run python export_to_md.py export --user "用户名" 2>&1

# 4. 文件结构
ls -la ../../data/
ls -la output/
```

## ✅ 验证修复

修复问题后，运行这些命令验证：
```bash
# 1. 基本功能测试
uv run python export_to_md.py list-users

# 2. 小规模导出测试  
uv run python export_to_md.py export --user "用户名" --limit 1

# 3. 检查输出文件
ls -la output/
unzip -l output/*.zip
```

## 🎯 常见成功案例

**正常的成功输出应该是这样的**：
```
🎯 开始导出用户: 经纬第二期
✅ 找到 265 条记录
🔄 正在转换为 Markdown...
✅ 导出成功!
📁 输出文件: output/经纬第二期_transcriptions.zip
📊 记录数量: 265
```

**正常的文件结构**：
```
output/
├── 经纬第二期_transcriptions.zip
└── (其他用户的文件...)
```

---

## 🏆 预防问题的最佳实践

1. **定期运行** 配置检查验证设置
2. **使用绝对路径** 而不是相对路径
3. **定期备份** 重要的配置文件
4. **检查磁盘空间** 确保有足够空间存储输出
5. **保持工具更新** 定期同步代码仓库

**记住：大多数问题都可以通过重新检查配置解决！** 🎉